<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Prenotazione Calcetto</title>
    <style>
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background-color: #f0f2f5; margin: 0; padding: 20px; }
        .container { max-width: 600px; margin: 0 auto; background: white; padding: 20px; border-radius: 12px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); }
        
        /* Titolo cliccabile per admin */
        h1 { text-align: center; color: #1565c0; margin-bottom: 5px; cursor: pointer; user-select: none; }
        h1:active { transform: scale(0.98); }
        
        .info-box { background: #e3f2fd; color: #0d47a1; padding: 15px; border-radius: 8px; text-align: center; margin-bottom: 20px; font-size: 1rem; border: 1px solid #bbdefb; font-weight: 500;}
        .status-closed { background: #ffebee; color: #c62828; border-color: #ffcdd2; }
        
        /* Stili Admin */
        .admin-active { border: 2px solid #d32f2f; background: #fffbfb; }
        .admin-panel { display: none; background: #ffebee; padding: 10px; border-radius: 8px; margin-bottom: 20px; border: 1px solid #ffcdd2; text-align: center; }
        .btn-email { background-color: #f57c00; color: white; border: none; padding: 10px 15px; border-radius: 6px; cursor: pointer; font-weight: bold; margin-top: 5px; width: 100%; font-size: 0.9rem;}
        .btn-email:hover { background-color: #e65100; }

        .form-group { display: flex; gap: 10px; margin-bottom: 20px; flex-wrap: wrap; }
        input { flex: 1; padding: 12px; border: 1px solid #ddd; border-radius: 8px; font-size: 16px; outline: none; }
        input:focus { border-color: #1565c0; }
        button#btn-prenota { background-color: #1565c0; color: white; border: none; padding: 12px 20px; border-radius: 8px; cursor: pointer; font-weight: bold; flex: 0 0 100%; transition: background 0.2s; }
        button#btn-prenota:hover { background-color: #0d47a1; }
        button:disabled { background-color: #9e9e9e !important; cursor: not-allowed; opacity: 0.7; }

        h2 { border-bottom: 2px solid #eee; padding-bottom: 10px; margin-top: 30px; font-size: 1.1rem; color: #333; display: flex; justify-content: space-between; align-items: center;}
        .badge-count { background: #eee; padding: 2px 8px; border-radius: 12px; font-size: 0.9rem; }
        
        .list-container { margin-bottom: 20px; }
        .player-card { display: flex; justify-content: space-between; padding: 12px; background: #fff; border-bottom: 1px solid #f0f0f0; align-items: center; transition: background 0.3s; }
        .player-card:last-child { border-bottom: none; }
        .player-card.is-me { background-color: #e8f5e9; border-left: 4px solid #4caf50; } 
        
        .player-left { display: flex; align-items: center; gap: 10px; }
        .player-index { color: #888; font-size: 0.9rem; min-width: 25px; font-weight: bold;}
        .player-name { font-weight: 600; color: #333; }
        
        .player-right { display: flex; align-items: center; gap: 10px; }
        .player-time { font-size: 0.75rem; color: #666; background: #f5f5f5; padding: 4px 8px; border-radius: 4px; }
        
        .reserves .player-time { background: #fff3e0; color: #e65100; }
        .reserves .player-index { color: #e65100; }
        
        .stats-container { margin-top: 40px; background: #fafafa; padding: 15px; border-radius: 8px; border: 1px solid #eee; }
        .stat-row { display: flex; justify-content: space-between; padding: 8px 0; font-size: 0.9rem; border-bottom: 1px dashed #eee; }
        .badge-presenze { background: #2e7d32; color: white; padding: 2px 8px; border-radius: 10px; font-size: 0.8rem; font-weight: bold;}

        /* Bottone delete admin - rosso scuro */
        .btn-delete.admin-del { background: #b71c1c; color: white; border-color: #b71c1c; }
        .btn-delete { background: #ffebee; color: #c62828; border: 1px solid #ffcdd2; border-radius: 4px; cursor: pointer; font-size: 0.9rem; padding: 5px 10px; transition: all 0.2s; }
        .btn-delete:hover { background: #c62828; color: white; }
    </style>
</head>
<body>

<div class="container" id="main-container">
    <h1 id="app-title" title="Clicca 3 volte per Admin">‚öΩ Partita del Luned√¨</h1>
    
    <div id="admin-panel" class="admin-panel">
        <strong>üîß Strumenti Admin Attivi</strong><br>
        <span style="font-size:0.8rem">Limiti rimossi. Puoi cancellare chiunque.</span>
        <button class="btn-email" id="btn-invia-email">üìß Crea Email Convocazioni</button>
    </div>

    <div id="info-box" class="info-box">Connessione al calendario...</div>
    
    <div class="form-group">
        <input type="text" id="nome" placeholder="Nome" required autocomplete="off">
        <input type="text" id="cognome" placeholder="Cognome" required autocomplete="off">
        <button id="btn-prenota" disabled>Caricamento...</button>
    </div>

    <div class="list-container">
        <h2>Titolari <span class="badge-count" id="count-titolari">0/16</span></h2>
        <div id="lista-titolari"></div>
    </div>

    <div class="list-container reserves">
        <h2>Riserve <span class="badge-count" id="count-riserve">0/16</span></h2>
        <div id="lista-riserve"></div>
    </div>

    <div class="stats-container">
        <h2 style="margin-top:0; border:none; font-size:1rem;">üèÜ Classifica Presenze</h2>
        <div id="lista-stats"></div>
    </div>
</div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getFirestore, collection, addDoc, deleteDoc, doc, onSnapshot, query, orderBy, where, setDoc, getDoc, updateDoc, increment, getDocs } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

    // --- CONFIGURAZIONE ---
    const firebaseConfig = {
      apiKey: "AIzaSyADBVqklh5V0e6HoHdhaMepc0lMlD_dS2w",
      authDomain: "calc8-c2b22.firebaseapp.com",
      projectId: "calc8-c2b22",
      storageBucket: "calc8-c2b22.firebasestorage.app",
      messagingSenderId: "694548999338",
      appId: "1:694548999338:web:0635e7ca4f3edf63b874d3"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const collPrenotazioni = "prenotazioni_calcetto";
    const collStats = "statistiche_giocatori";

    // --- VARIABILI GLOBALI ---
    const MAX_TITOLARI = 16;
    const MAX_RISERVE = 16;
    let dataPartitaTarget = ""; 
    let iscrizioniAperte = false;
    let prenotazioneUtenteLocale = localStorage.getItem('mio_id_prenotazione'); 
    
    // --- GESTIONE ADMIN ---
    let isAdmin = false;
    let adminClicks = 0;
    const ADMIN_PASSWORD = "admin"; 

    // Attivazione Admin con 3 click sul titolo
    document.getElementById('app-title').addEventListener('click', () => {
        adminClicks++;
        if (adminClicks === 3) {
            const pwd = prompt("üîí Accesso Admin: Inserisci Password");
            if (pwd === ADMIN_PASSWORD) {
                isAdmin = true;
                document.getElementById('main-container').classList.add('admin-active'); 
                document.getElementById('admin-panel').style.display = 'block'; 
                alert("Modalit√† Admin ATTIVA");
                // Ricalcoliamo le date e la lista per abilitare i bottoni
                calcolaLogicaDate();
                renderCurrentList(); 
            } else {
                alert("Password Errata!");
            }
            adminClicks = 0;
        }
    });

    // --- LOGICA EMAIL ---
    document.getElementById('btn-invia-email').addEventListener('click', () => {
        if (!lastSnapshotDocs || lastSnapshotDocs.length === 0) {
            alert("La lista √® vuota!");
            return;
        }

        // Formattazione data italiana per l'email
        const [anno, mese, giorno] = dataPartitaTarget.split('-');
        const dataLeggibile = `${giorno}/${mese}`;
        
        let corpoEmail = `Ciao a tutti,%0D%0AEcco i convocati per la partita di Luned√¨ ${dataLeggibile}.%0D%0A%0D%0A‚öΩ TITOLARI:%0D%0A`;

        const titolari = lastSnapshotDocs.slice(0, MAX_TITOLARI);
        titolari.forEach((p, index) => {
            corpoEmail += `${index + 1}. ${p.nome} ${p.cognome}%0D%0A`;
        });

        const riserve = lastSnapshotDocs.slice(MAX_TITOLARI, MAX_TITOLARI + MAX_RISERVE);
        if (riserve.length > 0) {
            corpoEmail += `%0D%0A‚ö†Ô∏è RISERVE:%0D%0A`;
            riserve.forEach((p, index) => {
                corpoEmail += `${index + 1}. ${p.nome} ${p.cognome}%0D%0A`;
            });
        }

        corpoEmail += `%0D%0AA presto!`;
        const oggetto = `Convocazioni Calcetto Luned√¨ ${dataLeggibile}`;
        window.location.href = `mailto:?subject=${oggetto}&body=${corpoEmail}`;
    });

    // --- LOGICA TEMPORALE (FIX FUSO ORARIO) ---
    function calcolaLogicaDate() {
        const adesso = new Date();
        const giornoSettimana = adesso.getDay(); // 0=Dom, 1=Lun...
        
        let giorniAlLunedi = (1 + 7 - giornoSettimana) % 7;
        // Se oggi √® Luned√¨, rimane oggi
        
        const dataLunedi = new Date(adesso);
        dataLunedi.setDate(adesso.getDate() + giorniAlLunedi);
        
        // Costruzione MANUALE della stringa data (YYYY-MM-DD) usando l'ora locale
        // Questo risolve il bug che mostrava il giorno prima (es. 07/12 invece di 08/12)
        const y = dataLunedi.getFullYear();
        const m = String(dataLunedi.getMonth() + 1).padStart(2, '0');
        const d = String(dataLunedi.getDate()).padStart(2, '0');
        dataPartitaTarget = `${y}-${m}-${d}`;

        const dataApertura = new Date(dataLunedi);
        dataApertura.setDate(dataLunedi.getDate() - 4); // Gioved√¨ precedente
        dataApertura.setHours(12, 0, 0, 0); 

        const dataChiusura = new Date(dataLunedi);
        dataChiusura.setHours(23, 59, 59, 999);

        const infoBox = document.getElementById('info-box');
        const btn = document.getElementById('btn-prenota');

        // L'Admin ignora sempre gli orari
        if (isAdmin || (adesso >= dataApertura && adesso <= dataChiusura)) {
            iscrizioniAperte = true;
            infoBox.className = "info-box";
            infoBox.innerHTML = `üü¢ Iscrizioni <b>APERTE</b> per Luned√¨ <b>${d}/${m}</b>`;
            
            if (!prenotazioneUtenteLocale && !isAdmin) {
                btn.disabled = false;
                btn.innerText = "Prenotati Ora";
            } else if (!isAdmin) {
                btn.disabled = true;
                btn.innerText = "Sei gi√† iscritto";
            }
        } else {
            iscrizioniAperte = false;
            infoBox.className = "info-box status-closed";
            infoBox.innerHTML = `üî¥ Iscrizioni CHIUSE.<br>Apriranno Gioved√¨ alle 12:00.`;
            if(!isAdmin) {
                btn.disabled = true;
                btn.innerText = "Attendi Apertura";
            }
        }
    }

    calcolaLogicaDate();
    setInterval(calcolaLogicaDate, 60000); // Ricalcola ogni minuto

    let lastSnapshotDocs = [];

    // --- CARICAMENTO LISTA ---
    const q = query(
        collection(db, collPrenotazioni), 
        where("data_partita", "==", dataPartitaTarget),
        orderBy("timestamp")
    );

    onSnapshot(q, (snapshot) => {
        lastSnapshotDocs = snapshot.docs.map(d => ({id: d.id, ...d.data()}));
        renderCurrentList();
    });

    function renderCurrentList() {
        const docs = lastSnapshotDocs;
        const listaTitolari = document.getElementById('lista-titolari');
        const listaRiserve = document.getElementById('lista-riserve');
        listaTitolari.innerHTML = '';
        listaRiserve.innerHTML = '';

        // Se Admin, abilita sempre il bottone
        if(isAdmin) {
             const btn = document.getElementById('btn-prenota');
             btn.disabled = false;
             btn.innerText = "Prenota (Admin Mode)";
        }

        // Controllo coerenza cache
        const myPrenotazione = docs.find(d => d.id === prenotazioneUtenteLocale);
        if (!myPrenotazione && !isAdmin) {
            localStorage.removeItem('mio_id_prenotazione');
            prenotazioneUtenteLocale = null;
            if(iscrizioniAperte) {
                document.getElementById('btn-prenota').disabled = false;
                document.getElementById('btn-prenota').innerText = "Prenotati Ora";
            }
        }

        // Contatori
        const countTitolari = Math.min(docs.length, MAX_TITOLARI);
        const countRiserve = Math.max(0, Math.min(docs.length - MAX_TITOLARI, MAX_RISERVE));

        document.getElementById('count-titolari').innerText = `${countTitolari}/${MAX_TITOLARI}`;
        document.getElementById('count-riserve').innerText = `${countRiserve}/${MAX_RISERVE}`;

        // Blocco Liste Piene (solo non-admin)
        if (iscrizioniAperte && !prenotazioneUtenteLocale && !isAdmin) {
            const btn = document.getElementById('btn-prenota');
            if (docs.length >= (MAX_TITOLARI + MAX_RISERVE)) {
                btn.disabled = true;
                btn.innerText = "Liste Complete!";
            }
        }

        if(docs.length === 0) listaTitolari.innerHTML = '<div style="padding:15px;text-align:center;color:#999;font-style:italic;">Nessun iscritto.</div>';

        docs.forEach((p, i) => {
            const isMe = (p.id === prenotazioneUtenteLocale);
            const showDelete = isMe || isAdmin;
            
            const html = `
                <div class="player-left">
                    <span class="player-index">${i + 1}.</span>
                    <span class="player-name">${p.nome} ${p.cognome} ${isMe ? '(Tu)' : ''}</span>
                </div>
                <div class="player-right">
                    <span class="player-time">${p.ora}</span>
                    ${showDelete ? `<button class="btn-delete ${isAdmin ? 'admin-del' : ''}" data-id="${p.id}" data-nome="${p.nome} ${p.cognome}">üóëÔ∏è</button>` : ''}
                </div>
            `;
            
            const div = document.createElement('div');
            div.className = `player-card ${isMe ? 'is-me' : ''}`;
            div.innerHTML = html;

            if (i < MAX_TITOLARI) listaTitolari.appendChild(div);
            else if (i < MAX_TITOLARI + MAX_RISERVE) listaRiserve.appendChild(div);
        });

        document.querySelectorAll('.btn-delete').forEach(btn => {
            btn.addEventListener('click', (e) => cancellaPrenotazione(e.target.dataset.id, e.target.dataset.nome));
        });
    }

    // --- CARICAMENTO STATISTICHE ---
    const qStats = query(collection(db, collStats), orderBy("presenze", "desc"));
    onSnapshot(qStats, (snapshot) => {
        const container = document.getElementById('lista-stats');
        container.innerHTML = '';
        let count = 0;
        snapshot.forEach(doc => {
            if(count >= 10) return; // Top 10
            const d = doc.data();
            const row = document.createElement('div');
            row.className = 'stat-row';
            row.innerHTML = `
                <span>${count+1}. <b>${d.nome_completo}</b></span>
                <span class="badge-presenze">${d.presenze}</span>
            `;
            container.appendChild(row);
            count++;
        });
    });

    // --- AZIONE: PRENOTA ---
    document.getElementById('btn-prenota').addEventListener('click', async () => {
        if (!iscrizioniAperte && !isAdmin) return;
        if (prenotazioneUtenteLocale && !isAdmin) { alert("Risulti gi√† iscritto sul dispositivo!"); return; }

        const nome = document.getElementById('nome').value.trim();
        const cognome = document.getElementById('cognome').value.trim();
        if (!nome || !cognome) { alert("Compila tutti i campi"); return; }

        const btn = document.getElementById('btn-prenota');
        btn.disabled = true;
        btn.innerText = "Verifica...";

        // Formattazione
        const formatName = (str) => str.charAt(0).toUpperCase() + str.slice(1).toLowerCase();
        const nomeF = formatName(nome);
        const cognomeF = formatName(cognome);
        const nomeCompleto = `${nomeF} ${cognomeF}`;
        const statsId = `${nomeF.toLowerCase()}_${cognomeF.toLowerCase()}`.replace(/\s+/g, '');
        
        try {
            // Check Doppioni (Se NON sono admin)
            if (!isAdmin) {
                const qCheck = query(collection(db, collPrenotazioni), where("data_partita", "==", dataPartitaTarget), where("nome", "==", nomeF), where("cognome", "==", cognomeF));
                const snapshotCheck = await getDocs(qCheck);
                if (!snapshotCheck.empty) {
                    alert(`Attenzione: ${nomeCompleto} √® gi√† in lista!`);
                    btn.disabled = false;
                    btn.innerText = "Prenotati Ora";
                    return; 
                }
            }

            btn.innerText = "Salvataggio...";

            // 1. Salva Prenotazione
            const docRef = await addDoc(collection(db, collPrenotazioni), {
                nome: nomeF,
                cognome: cognomeF,
                data_partita: dataPartitaTarget,
                ora: new Date().toLocaleTimeString('it-IT', {hour:'2-digit', minute:'2-digit'}),
                timestamp: Date.now()
            });

            // 2. Salva Cache (solo se non Admin)
            if (!isAdmin) {
                localStorage.setItem('mio_id_prenotazione', docRef.id);
                prenotazioneUtenteLocale = docRef.id;
            }

            // 3. Aggiorna Statistiche
            const statsRef = doc(db, collStats, statsId);
            const statsSnap = await getDoc(statsRef);
            if (statsSnap.exists()) {
                await updateDoc(statsRef, { presenze: increment(1), nome_completo: nomeCompleto });
            } else {
                await setDoc(statsRef, { nome_completo: nomeCompleto, presenze: 1 });
            }

            document.getElementById('nome').value = '';
            document.getElementById('cognome').value = '';
            
            if(isAdmin) {
                btn.disabled = false; 
                btn.innerText = "Prenota (Admin Mode)";
            }

        } catch (e) {
            console.error(e);
            alert("Errore. Riprova.");
            btn.disabled = false;
            btn.innerText = "Prenotati Ora";
        }
    });

    // --- AZIONE: CANCELLA ---
    async function cancellaPrenotazione(idDoc, nomeCompletoOriginale) {
        let msg = "Sicuro di voler lasciare il posto?";
        if (isAdmin) msg = `ADMIN: Vuoi cancellare definitivamente ${nomeCompletoOriginale}?`;

        if(!confirm(msg)) return;

        try {
            // Ricostruzione ID Stats (stesso metodo della prenotazione)
            const statsId = nomeCompletoOriginale.toLowerCase().replace(/\s+/g, '_');

            // 1. Cancella dal DB
            await deleteDoc(doc(db, collPrenotazioni, idDoc));

            // 2. Rimuovi Cache (solo se sono io)
            if (idDoc === prenotazioneUtenteLocale) {
                localStorage.removeItem('mio_id_prenotazione');
                prenotazioneUtenteLocale = null;
            }
            
            // 3. Rimuovi Presenza (-1)
            const statsRef = doc(db, collStats, statsId);
            await updateDoc(statsRef, { presenze: increment(-1) });

        } catch (e) {
            console.error(e);
            alert("Errore cancellazione.");
        }
    }
</script>

</body>
</html>

<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Prenotazione Calcetto</title>
    <style>
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background-color: #f0f2f5; margin: 0; padding: 20px; }
        .container { max-width: 600px; margin: 0 auto; background: white; padding: 20px; border-radius: 12px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); }
        h1 { text-align: center; color: #1565c0; margin-bottom: 5px; }
        .subtitle { text-align: center; color: #666; margin-bottom: 20px; font-size: 0.9rem; }
        
        .form-group { display: flex; gap: 10px; margin-bottom: 20px; flex-wrap: wrap; }
        input { flex: 1; padding: 10px; border: 1px solid #ddd; border-radius: 6px; }
        button { background-color: #1565c0; color: white; border: none; padding: 10px 20px; border-radius: 6px; cursor: pointer; font-weight: bold; }
        button:hover { background-color: #0d47a1; }
        button:disabled { background-color: #ccc; cursor: not-allowed; }

        h2 { border-bottom: 2px solid #eee; padding-bottom: 10px; margin-top: 30px; font-size: 1.2rem; }
        .list-container { margin-bottom: 20px; }
        .player-card { display: flex; justify-content: space-between; padding: 10px; background: #f9f9f9; border-bottom: 1px solid #eee; align-items: center; }
        .player-card:nth-child(odd) { background: #fff; }
        .player-info { font-weight: 500; }
        .player-time { font-size: 0.85rem; color: #666; background: #e3f2fd; padding: 4px 8px; border-radius: 12px; }
        .counter { float: right; font-size: 0.9rem; color: #555; font-weight: normal; }
        
        .reserves .player-time { background: #fff3e0; color: #e65100; }
        
        #status-msg { text-align: center; font-size: 0.9rem; color: #666; margin-bottom: 10px; min-height: 20px;}
        .date-badge { display: block; text-align: center; background: #e8f5e9; color: #2e7d32; padding: 5px; border-radius: 4px; margin-bottom: 15px; font-weight: bold;}
    </style>
</head>
<body>

<div class="container">
    <h1>‚öΩ Calcetto Live</h1>
    <div id="display-data-partita" class="date-badge">Caricamento data...</div>
    <div id="status-msg">Connessione in corso...</div>
    
    <div class="form-group">
        <input type="text" id="nome" placeholder="Nome" required>
        <input type="text" id="cognome" placeholder="Cognome" required>
        <button id="btn-prenota">Prenotati</button>
    </div>

    <div class="list-container">
        <h2>Titolari <span class="counter" id="count-titolari">0/16</span></h2>
        <div id="lista-titolari"></div>
    </div>

    <div class="list-container reserves">
        <h2>Riserve <span class="counter" id="count-riserve">0/16</span></h2>
        <div id="lista-riserve"></div>
    </div>
</div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getFirestore, collection, addDoc, onSnapshot, query, orderBy, where } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

    // --- LA TUA CONFIGURAZIONE FIREBASE ---
    const firebaseConfig = {
        apiKey: "AIzaSyADBVqklh5V0e6HoHdhaMepc0lMlD_dS2w",
        authDomain: "calc8-c2b22.firebaseapp.com",
        projectId: "calc8-c2b22",
        storageBucket: "calc8-c2b22.firebasestorage.app",
        messagingSenderId: "694548999338",
        appId: "1:694548999338:web:0635e7ca4f3edf63b874d3"
    };
    // --------------------------------------

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const collectionName = "prenotazioni_calcetto";

    // --- LOGICA DATE (Reset settimanale automatico) ---
    function getDataPartita() {
        const oggi = new Date();
        const giornoSettimana = oggi.getDay(); // 0=Dom, 1=Lun, ... 4=Giov ... 6=Sab
        
        // Calcolo giorni mancanti al prossimo Gioved√¨ (4)
        // Se oggi √® Ven(5) o Sab(6), punta al prossimo. Se oggi √® Dom(0)-Merc(3), punta a questo.
        let giorniMancanti = (4 - giornoSettimana + 7) % 7;
        
        const dataTarget = new Date(oggi);
        dataTarget.setDate(oggi.getDate() + giorniMancanti);
        
        return dataTarget.toISOString().split('T')[0];
    }
    
    function formattaData(dataString) {
        const [y, m, d] = dataString.split('-');
        return `${d}/${m}/${y}`;
    }

    const dataCorrenteMatch = getDataPartita();
    document.getElementById('display-data-partita').innerText = `Iscrizioni per Gioved√¨ ${formattaData(dataCorrenteMatch)}`;

    const MAX_TITOLARI = 16;
    const MAX_RISERVE = 16;
    let totaleGiocatori = 0;

    // --- QUERY CON FILTRO DATA ---
    const q = query(
        collection(db, collectionName), 
        where("data_partita", "==", dataCorrenteMatch),
        orderBy("timestamp")
    );

    onSnapshot(q, (snapshot) => {
        const listaTitolari = document.getElementById('lista-titolari');
        const listaRiserve = document.getElementById('lista-riserve');
        listaTitolari.innerHTML = '';
        listaRiserve.innerHTML = '';
        
        let giocatori = [];
        snapshot.forEach((doc) => {
            giocatori.push({ id: doc.id, ...doc.data() });
        });

        totaleGiocatori = giocatori.length;
        document.getElementById('status-msg').innerText = ""; 

        if (giocatori.length === 0) {
            document.getElementById('lista-titolari').innerHTML = '<div style="padding:10px; color:#999; text-align:center">Ancora nessun iscritto per questa data.</div>';
        }

        giocatori.forEach((g, index) => {
            const div = document.createElement('div');
            div.className = 'player-card';
            div.innerHTML = `
                <span class="player-info">${index + 1}. ${g.nome} ${g.cognome}</span>
                <span class="player-time">üïí ${g.ora}</span>
            `;

            if (index < MAX_TITOLARI) {
                listaTitolari.appendChild(div);
            } else if (index < (MAX_TITOLARI + MAX_RISERVE)) {
                listaRiserve.appendChild(div);
            }
        });

        const numTitolari = Math.min(giocatori.length, MAX_TITOLARI);
        const numRiserve = Math.max(0, Math.min(giocatori.length - MAX_TITOLARI, MAX_RISERVE));
        document.getElementById('count-titolari').innerText = `${numTitolari}/${MAX_TITOLARI}`;
        document.getElementById('count-riserve').innerText = `${numRiserve}/${MAX_RISERVE}`;
    }, (error) => {
        console.error("Errore Firebase:", error);
        if (error.message.includes("requires an index")) {
            document.getElementById('status-msg').innerHTML = `<span style="color:red; font-weight:bold;">‚ö†Ô∏è AZIONE RICHIESTA: Apri la console (F12) e clicca sul link di Firebase per creare l'indice!</span>`;
        }
    });

    // Funzione Prenotazione
    document.getElementById('btn-prenota').addEventListener('click', async () => {
        const nomeIn = document.getElementById('nome');
        const cognomeIn = document.getElementById('cognome');
        const nome = nomeIn.value.trim();
        const cognome = cognomeIn.value.trim();

        if (!nome || !cognome) { alert("Inserisci nome e cognome!"); return; }
        
        if (totaleGiocatori >= (MAX_TITOLARI + MAX_RISERVE)) { alert("Liste piene!"); return; }

        document.getElementById('status-msg').innerText = "Salvataggio...";
        
        const adesso = new Date();
        const orario = adesso.toLocaleTimeString('it-IT', { hour: '2-digit', minute: '2-digit' });

        try {
            await addDoc(collection(db, collectionName), {
                nome: nome,
                cognome: cognome,
                ora: orario,
                timestamp: Date.now(),
                data_partita: dataCorrenteMatch
            });
            nomeIn.value = '';
            cognomeIn.value = '';
        } catch (e) {
            console.error("Errore: ", e);
            alert("Errore nel salvataggio.");
        }
    });
</script>

</body>
</html>

<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Prenotazione Calc8</title>
    <style>
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background-color: #f0f2f5; margin: 0; padding: 20px; }
        .container { max-width: 600px; margin: 0 auto; background: white; padding: 20px; border-radius: 12px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); }
        
        /* Titolo cliccabile per admin */
        h1 { text-align: center; color: #1565c0; margin-bottom: 5px; cursor: pointer; user-select: none; }
        h1:active { transform: scale(0.98); }

        .info-box { background: #e3f2fd; color: #0d47a1; padding: 15px; border-radius: 8px; text-align: center; margin-bottom: 20px; font-size: 1rem; border: 1px solid #bbdefb; font-weight: 500;}
        .status-closed { background: #ffebee; color: #c62828; border-color: #ffcdd2; }
        .admin-active { border: 2px solid red; background: #fff0f0; } /* Stile quando sei admin */
        
        .form-group { display: flex; gap: 10px; margin-bottom: 20px; flex-wrap: wrap; }
        input { flex: 1; padding: 12px; border: 1px solid #ddd; border-radius: 8px; font-size: 16px; outline: none; }
        input:focus { border-color: #1565c0; }
        button#btn-prenota { background-color: #1565c0; color: white; border: none; padding: 12px 20px; border-radius: 8px; cursor: pointer; font-weight: bold; flex: 0 0 100%; transition: background 0.2s; }
        button#btn-prenota:hover { background-color: #0d47a1; }
        button:disabled { background-color: #9e9e9e !important; cursor: not-allowed; opacity: 0.7; }

        h2 { border-bottom: 2px solid #eee; padding-bottom: 10px; margin-top: 30px; font-size: 1.1rem; color: #333; display: flex; justify-content: space-between; align-items: center;}
        .badge-count { background: #eee; padding: 2px 8px; border-radius: 12px; font-size: 0.9rem; }
        
        .list-container { margin-bottom: 20px; }
        .player-card { display: flex; justify-content: space-between; padding: 12px; background: #fff; border-bottom: 1px solid #f0f0f0; align-items: center; transition: background 0.3s; }
        .player-card:last-child { border-bottom: none; }
        .player-card.is-me { background-color: #e8f5e9; border-left: 4px solid #4caf50; } 
        
        .player-left { display: flex; align-items: center; gap: 10px; }
        .player-index { color: #888; font-size: 0.9rem; min-width: 25px; font-weight: bold;}
        .player-name { font-weight: 600; color: #333; }
        
        .player-right { display: flex; align-items: center; gap: 10px; }
        .player-time { font-size: 0.75rem; color: #666; background: #f5f5f5; padding: 4px 8px; border-radius: 4px; }
        
        .reserves .player-time { background: #fff3e0; color: #e65100; }
        .reserves .player-index { color: #e65100; }
        
        .stats-container { margin-top: 40px; background: #fafafa; padding: 15px; border-radius: 8px; border: 1px solid #eee; }
        .stat-row { display: flex; justify-content: space-between; padding: 8px 0; font-size: 0.9rem; border-bottom: 1px dashed #eee; }
        .badge-presenze { background: #2e7d32; color: white; padding: 2px 8px; border-radius: 10px; font-size: 0.8rem; font-weight: bold;}

        /* Bottone delete admin - rosso scuro */
        .btn-delete.admin-del { background: #b71c1c; color: white; border-color: #b71c1c; }
        .btn-delete { background: #ffebee; color: #c62828; border: 1px solid #ffcdd2; border-radius: 4px; cursor: pointer; font-size: 0.9rem; padding: 5px 10px; transition: all 0.2s; }
        .btn-delete:hover { background: #c62828; color: white; }
    </style>
</head>
<body>

<div class="container" id="main-container">
    <h1 id="app-title" title="Clicca 3 volte per Admin">‚öΩ Partita del Luned√¨</h1>
    
    <div id="info-box" class="info-box">Connessione al calendario...</div>
    
    <div class="form-group">
        <input type="text" id="nome" placeholder="Nome" required autocomplete="off">
        <input type="text" id="cognome" placeholder="Cognome" required autocomplete="off">
        <button id="btn-prenota" disabled>Caricamento...</button>
    </div>

    <div class="list-container">
        <h2>Titolari <span class="badge-count" id="count-titolari">0/16</span></h2>
        <div id="lista-titolari"></div>
    </div>

    <div class="list-container reserves">
        <h2>Riserve <span class="badge-count" id="count-riserve">0/16</span></h2>
        <div id="lista-riserve"></div>
    </div>

    <div class="stats-container">
        <h2 style="margin-top:0; border:none; font-size:1rem;">üèÜ Classifica Presenze</h2>
        <div id="lista-stats"></div>
    </div>
</div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getFirestore, collection, addDoc, deleteDoc, doc, onSnapshot, query, orderBy, where, setDoc, getDoc, updateDoc, increment, getDocs } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

    // --- CONFIGURAZIONE ---
    const firebaseConfig = {
      apiKey: "AIzaSyADBVqklh5V0e6HoHdhaMepc0lMlD_dS2w",
      authDomain: "calc8-c2b22.firebaseapp.com",
      projectId: "calc8-c2b22",
      storageBucket: "calc8-c2b22.firebasestorage.app",
      messagingSenderId: "694548999338",
      appId: "1:694548999338:web:0635e7ca4f3edf63b874d3"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const collPrenotazioni = "prenotazioni_calcetto";
    const collStats = "statistiche_giocatori";

    // --- VARIABILI GLOBALI ---
    const MAX_TITOLARI = 16;
    const MAX_RISERVE = 16;
    let dataPartitaTarget = ""; 
    let iscrizioniAperte = false;
    let prenotazioneUtenteLocale = localStorage.getItem('mio_id_prenotazione'); 
    
    // --- GESTIONE ADMIN ---
    let isAdmin = false;
    let adminClicks = 0;
    const ADMIN_PASSWORD = "admin"; // <--- CAMBIA QUESTA PASSWORD SE VUOI

    // Logica Clic Segreto sul Titolo
    document.getElementById('app-title').addEventListener('click', () => {
        adminClicks++;
        if (adminClicks === 3) {
            const pwd = prompt("üîí Accesso Admin: Inserisci Password");
            if (pwd === ADMIN_PASSWORD) {
                isAdmin = true;
                document.getElementById('main-container').classList.add('admin-active'); // Feedback visivo
                alert("Modalit√† Admin ATTIVA: Ora puoi cancellare chiunque.");
                // Forziamo il ricaricamento della lista per mostrare i bottoni
                // (Trucco: la funzione onSnapshot si aggiorner√† al prossimo evento, 
                // ma per vederlo subito ricarichiamo la pagina o aspettiamo un secondo.
                // Meglio: Ricarichiamo la pagina in modo "silenzioso" o aspettiamo l'update)
                renderCurrentList(); // Richiamiamo render se avessimo i dati, ma qui aspettiamo l'update
            } else {
                alert("Password Errata!");
            }
            adminClicks = 0;
        }
    });

    // --- LOGICA TEMPORALE ---
    function calcolaLogicaDate() {
        const adesso = new Date();
        const giornoSettimana = adesso.getDay(); 
        
        let giorniAlLunedi = (1 + 7 - giornoSettimana) % 7;
        if (giornoSettimana === 1) giorniAlLunedi = 0; 

        const dataLunedi = new Date(adesso);
        dataLunedi.setDate(adesso.getDate() + giorniAlLunedi);
        dataPartitaTarget = dataLunedi.toISOString().split('T')[0];

        const dataApertura = new Date(dataLunedi);
        dataApertura.setDate(dataLunedi.getDate() - 4); 
        dataApertura.setHours(12, 0, 0, 0); // GIOVEDI ORE 12

        const dataChiusura = new Date(dataLunedi);
        dataChiusura.setHours(23, 59, 59, 0);

        const infoBox = document.getElementById('info-box');
        const btn = document.getElementById('btn-prenota');

        // Se sono ADMIN salto i controlli di orario
        if (adesso >= dataApertura && adesso <= dataChiusura) {
            iscrizioniAperte = true;
            infoBox.className = "info-box";
            infoBox.innerHTML = `üü¢ Iscrizioni <b>APERTE</b> per Luned√¨ <b>${formattaData(dataPartitaTarget)}</b>`;
            
            if (!prenotazioneUtenteLocale) {
                btn.disabled = false;
                btn.innerText = "Prenotati Ora";
            } else {
                btn.disabled = true;
                btn.innerText = "Sei gi√† iscritto";
            }
        } else {
            iscrizioniAperte = false;
            infoBox.className = "info-box status-closed";
            infoBox.innerHTML = `üî¥ Iscrizioni CHIUSE.<br>Apriranno Gioved√¨ alle 12:00.`;
            btn.disabled = true;
            btn.innerText = "Attendi Apertura";
        }
    }

    function formattaData(str) {
        if(!str) return "...";
        const [y, m, d] = str.split('-');
        return `${d}/${m}`;
    }

    calcolaLogicaDate();
    setInterval(calcolaLogicaDate, 60000);

    // Variabile per salvare l'ultimo snapshot (per ri-renderizzare se divento admin)
    let lastSnapshotDocs = [];

    // --- CARICAMENTO LISTA ---
    const q = query(
        collection(db, collPrenotazioni), 
        where("data_partita", "==", dataPartitaTarget),
        orderBy("timestamp")
    );

    onSnapshot(q, (snapshot) => {
        lastSnapshotDocs = snapshot.docs.map(d => ({id: d.id, ...d.data()}));
        renderCurrentList();
    });

    function renderCurrentList() {
        const docs = lastSnapshotDocs;
        const listaTitolari = document.getElementById('lista-titolari');
        const listaRiserve = document.getElementById('lista-riserve');
        listaTitolari.innerHTML = '';
        listaRiserve.innerHTML = '';

        // Se sono admin, il pulsante prenota √® sempre abilitato (utile per inserire gente a mano)
        if(isAdmin) {
             document.getElementById('btn-prenota').disabled = false;
             document.getElementById('btn-prenota').innerText = "Prenota (Admin Mode)";
        }

        const myPrenotazione = docs.find(d => d.id === prenotazioneUtenteLocale);
        if (!myPrenotazione && !isAdmin) {
            localStorage.removeItem('mio_id_prenotazione');
            prenotazioneUtenteLocale = null;
            if(iscrizioniAperte) {
                document.getElementById('btn-prenota').disabled = false;
                document.getElementById('btn-prenota').innerText = "Prenotati Ora";
            }
        }

        const countTitolari = Math.min(docs.length, MAX_TITOLARI);
        const countRiserve = Math.max(0, Math.min(docs.length - MAX_TITOLARI, MAX_RISERVE));

        document.getElementById('count-titolari').innerText = `${countTitolari}/${MAX_TITOLARI}`;
        document.getElementById('count-riserve').innerText = `${countRiserve}/${MAX_RISERVE}`;

        // Blocco bottone liste piene (se non sono admin)
        if (iscrizioniAperte && !prenotazioneUtenteLocale && !isAdmin) {
            const btn = document.getElementById('btn-prenota');
            if (docs.length >= (MAX_TITOLARI + MAX_RISERVE)) {
                btn.disabled = true;
                btn.innerText = "Liste Complete!";
            }
        }

        if(docs.length === 0) listaTitolari.innerHTML = '<div style="padding:15px;text-align:center;color:#999;font-style:italic;">Nessun iscritto.</div>';

        docs.forEach((p, i) => {
            const isMe = (p.id === prenotazioneUtenteLocale);
            // IL CESTINO APPARE SE: √à l'utente (isMe) OPPURE se Admin √® attivo (isAdmin)
            const showDelete = isMe || isAdmin;
            
            const html = `
                <div class="player-left">
                    <span class="player-index">${i + 1}.</span>
                    <span class="player-name">${p.nome} ${p.cognome} ${isMe ? '(Tu)' : ''}</span>
                </div>
                <div class="player-right">
                    <span class="player-time">${p.ora}</span>
                    ${showDelete ? `<button class="btn-delete ${isAdmin ? 'admin-del' : ''}" data-id="${p.id}" data-nome="${p.nome} ${p.cognome}">üóëÔ∏è</button>` : ''}
                </div>
            `;
            
            const div = document.createElement('div');
            div.className = `player-card ${isMe ? 'is-me' : ''}`;
            div.innerHTML = html;

            if (i < MAX_TITOLARI) listaTitolari.appendChild(div);
            else if (i < MAX_TITOLARI + MAX_RISERVE) listaRiserve.appendChild(div);
        });

        document.querySelectorAll('.btn-delete').forEach(btn => {
            btn.addEventListener('click', (e) => cancellaPrenotazione(e.target.dataset.id, e.target.dataset.nome));
        });
    }

    // --- CARICAMENTO CLASSIFICA PRESENZE ---
    const qStats = query(collection(db, collStats), orderBy("presenze", "desc"));
    onSnapshot(qStats, (snapshot) => {
        const container = document.getElementById('lista-stats');
        container.innerHTML = '';
        let count = 0;
        snapshot.forEach(doc => {
            if(count >= 10) return;
            const d = doc.data();
            const row = document.createElement('div');
            row.className = 'stat-row';
            row.innerHTML = `
                <span>${count+1}. <b>${d.nome_completo}</b></span>
                <span class="badge-presenze">${d.presenze}</span>
            `;
            container.appendChild(row);
            count++;
        });
    });

    // --- AZIONI ---
    document.getElementById('btn-prenota').addEventListener('click', async () => {
        // Se Admin, ignora i blocchi
        if (!iscrizioniAperte && !isAdmin) return;
        if (prenotazioneUtenteLocale && !isAdmin) { alert("Risulti gi√† iscritto sul dispositivo!"); return; }

        const nome = document.getElementById('nome').value.trim();
        const cognome = document.getElementById('cognome').value.trim();
        if (!nome || !cognome) { alert("Compila tutti i campi"); return; }

        const btn = document.getElementById('btn-prenota');
        btn.disabled = true;
        btn.innerText = "Verifica...";

        const formatName = (str) => str.charAt(0).toUpperCase() + str.slice(1).toLowerCase();
        const nomeF = formatName(nome);
        const cognomeF = formatName(cognome);
        const nomeCompleto = `${nomeF} ${cognomeF}`;
        const statsId = `${nomeF.toLowerCase()}_${cognomeF.toLowerCase()}`.replace(/\s+/g, '');
        
        try {
            // Check Doppioni (solo se non sono admin, l'admin pu√≤ fare quel che vuole)
            if (!isAdmin) {
                const qCheck = query(collection(db, collPrenotazioni), where("data_partita", "==", dataPartitaTarget), where("nome", "==", nomeF), where("cognome", "==", cognomeF));
                const snapshotCheck = await getDocs(qCheck);
                if (!snapshotCheck.empty) {
                    alert(`Attenzione: ${nomeCompleto} √® gi√† in lista!`);
                    btn.disabled = false;
                    btn.innerText = "Prenotati Ora";
                    return; 
                }
            }

            btn.innerText = "Salvataggio...";

            const docRef = await addDoc(collection(db, collPrenotazioni), {
                nome: nomeF,
                cognome: cognomeF,
                data_partita: dataPartitaTarget,
                ora: new Date().toLocaleTimeString('it-IT', {hour:'2-digit', minute:'2-digit'}),
                timestamp: Date.now()
            });

            // Se non sono admin, salvo la mia identit√†. Se sono admin, sto inserendo un altro, quindi non salvo l'ID come "mio"
            if (!isAdmin) {
                localStorage.setItem('mio_id_prenotazione', docRef.id);
                prenotazioneUtenteLocale = docRef.id;
            }

            const statsRef = doc(db, collStats, statsId);
            const statsSnap = await getDoc(statsRef);
            if (statsSnap.exists()) {
                await updateDoc(statsRef, { presenze: increment(1), nome_completo: nomeCompleto });
            } else {
                await setDoc(statsRef, { nome_completo: nomeCompleto, presenze: 1 });
            }

            document.getElementById('nome').value = '';
            document.getElementById('cognome').value = '';
            
            // Se Admin, riabilito subito il bottone per inserirne un altro
            if(isAdmin) {
                btn.disabled = false; 
                btn.innerText = "Prenota (Admin Mode)";
            }

        } catch (e) {
            console.error(e);
            alert("Errore. Riprova.");
            btn.disabled = false;
            btn.innerText = "Prenotati Ora";
        }
    });

    async function cancellaPrenotazione(idDoc, nomeCompletoOriginale) {
        // Messaggio diverso se sei admin
        let msg = "Sicuro di voler lasciare il posto?";
        if (isAdmin) msg = `ADMIN: Vuoi cancellare definitivamente ${nomeCompletoOriginale}?`;

        if(!confirm(msg)) return;

        try {
            const statsId = nomeCompletoOriginale.toLowerCase().split(' ').join('_');

            await deleteDoc(doc(db, collPrenotazioni, idDoc));

            // Se cancello "me stesso", resetto la cache. Se Admin cancella un altro, la cache non si tocca
            if (idDoc === prenotazioneUtenteLocale) {
                localStorage.removeItem('mio_id_prenotazione');
                prenotazioneUtenteLocale = null;
            }
            
            // Stats -1
            const statsRef = doc(db, collStats, statsId);
            await updateDoc(statsRef, { presenze: increment(-1) });

        } catch (e) {
            console.error(e);
            alert("Errore cancellazione.");
        }
    }
</script>

</body>
</html>
